!function(e){"use strict";var t={_initialized:!1,_endpoint:null,_sessionId:null,_userId:null,_sessionTimeout:18e5,_lastActivity:null,_boundHandlers:{},init:function(e){if(!e||!e.endpoint)return void console.error("Ultralytics: endpoint is required");this._initialized&&this._removeEventListeners(),this._endpoint=e.endpoint.replace(/\/$/,""),this._lastActivity=Date.now(),this._initSession(),this._initialized=!0,this._restoreUserId();var t=this;this._boundHandlers.visibilityChange=function(){"visible"===document.visibilityState&&t._checkSession()},this._boundHandlers.beforeUnload=function(){t._lastActivity=Date.now()},document.addEventListener("visibilitychange",this._boundHandlers.visibilityChange),e.addEventListener("beforeunload",this._boundHandlers.beforeUnload),console.log("Ultralytics initialized")},_initSession:function(){var e=this._getStoredSession();e&&Date.now()-e.lastActivity<this._sessionTimeout?(this._sessionId=e.id,this._lastActivity=e.lastActivity):this._sessionId=this._generateId(),this._storeSession()},_checkSession:function(){(!this._lastActivity||Date.now()-this._lastActivity>this._sessionTimeout)&&(this._sessionId=this._generateId()),this._lastActivity=Date.now(),this._storeSession()},_generateId:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},_storeSession:function(){try{localStorage.setItem("ultralytics_session",JSON.stringify({id:this._sessionId,lastActivity:this._lastActivity}))}catch(e){}},_getStoredSession:function(){try{var e=localStorage.getItem("ultralytics_session");return e?JSON.parse(e):null}catch(e){return null}},_restoreUserId:function(){try{var e=localStorage.getItem("ultralytics_user_id");e&&(this._userId=e)}catch(e){}},track:function(e,t){if(!this._initialized)return void console.error("Ultralytics: not initialized. Call init() first.");this._sessionId||(this._sessionId=this._generateId(),this._storeSession()),this._lastActivity=Date.now(),this._storeSession();var s={name:e,properties:t||{},sessionId:this._sessionId,userId:this._userId,timestamp:(new Date).toISOString()};this._send("/api/events",s)},trackPageView:function(e){var t={url:window.location.href,path:window.location.pathname,title:document.title,referrer:document.referrer||null};if(e)for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);this.track("page_view",t)},_removeEventListeners:function(){this._boundHandlers.visibilityChange&&document.removeEventListener("visibilitychange",this._boundHandlers.visibilityChange),this._boundHandlers.beforeUnload&&e.removeEventListener("beforeunload",this._boundHandlers.beforeUnload),this._boundHandlers={}},destroy:function(){this._initialized&&(this._removeEventListeners(),this._initialized=!1,this._endpoint=null,this._sessionId=null,this._userId=null,console.log("Ultralytics destroyed"))},trackEvent:function(e,t){var s={eventType:"custom"};if(t)for(var i in t)t.hasOwnProperty(i)&&(s[i]=t[i]);this.track(e,s)},identify:function(e,t){if(!this._initialized)return void console.error("Ultralytics: not initialized. Call init() first.");if(!e)return void console.error("Ultralytics: userId is required for identify()");this._userId=e;try{localStorage.setItem("ultralytics_user_id",e)}catch(e){}t&&this.track("identify",t),console.log("Ultralytics: user identified",e)},getUserId:function(){return this._userId},clearUser:function(){this._userId=null;try{localStorage.removeItem("ultralytics_user_id")}catch(e){}},trackBatch:function(e,t){if(!this._initialized){var s=new Error("Ultralytics: not initialized. Call init() first.");return console.error(s.message),void(t&&t(s))}if(!Array.isArray(e)||0===e.length){var s=new Error("Ultralytics: events must be a non-empty array");return console.error(s.message),void(t&&t(s))}this._lastActivity=Date.now(),this._storeSession();var i=this,n=e.map(function(e){return{name:e.name,properties:e.properties||{},sessionId:i._sessionId,userId:i._userId,timestamp:e.timestamp||(new Date).toISOString()}});this._sendBatch(n,t)},_sendBatch:function(e,t){var s=new XMLHttpRequest;s.open("POST",this._endpoint+"/api/events/batch",!0),s.setRequestHeader("Content-Type","application/json"),s.onreadystatechange=function(){if(4===s.readyState)if(s.status>=200&&s.status<300){if(t)try{var e=JSON.parse(s.responseText);t(null,e)}catch(e){t(null,{success:!0})}}else{var i=new Error("Failed to send batch: "+s.status);console.error("Ultralytics: failed to send batch",s.status),t&&t(i)}},s.send(JSON.stringify({events:e}))},_send:function(e,t){var s=new XMLHttpRequest;s.open("POST",this._endpoint+e,!0),s.setRequestHeader("Content-Type","application/json"),s.onreadystatechange=function(){4===s.readyState&&(s.status>=200&&s.status<300||console.error("Ultralytics: failed to send event",s.status))},s.send(JSON.stringify(t))}};e.Ultralytics=t}(window);
