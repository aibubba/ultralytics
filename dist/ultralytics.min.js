!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.UltralyticsClient=exports.Ultralytics=void 0;const t="ultralytics_session",s="ultralytics_user_id";class e{constructor(){this._initialized=!1,this._endpoint=null,this._sessionId=null,this._userId=null,this._sessionTimeout=18e5,this._lastActivity=null,this._boundHandlers={},this._autoTrack=!1,this._lastTrackedPath=null,this._debug=!1,this._pendingEvents=0,this._eventsSent=0,this._errorCount=0,this._storage={get:t=>{try{return localStorage.getItem(t)}catch{return null}},set:(t,s)=>{try{localStorage.setItem(t,s)}catch{}},remove:t=>{try{localStorage.removeItem(t)}catch{}}}}_log(t,s,e){if(!this._debug)return;const i=`[Ultralytics ${(new Date).toISOString()}]`,n="error"===t?console.error:"warn"===t?console.warn:console.log;void 0!==e?n(`${i} ${s}`,e):n(`${i} ${s}`)}_logDebug(t,s){this._log("debug",t,s)}_logInfo(t,s){this._log("info",t,s)}_logWarn(t,s){this._log("warn",t,s)}_logError(t,s){this._log("error",t,s),this._errorCount++}getDebugInfo(){return{initialized:this._initialized,endpoint:this._endpoint,sessionId:this._sessionId,userId:this._userId,autoTrack:this._autoTrack,lastActivity:this._lastActivity,sessionAge:this._lastActivity?Date.now()-this._lastActivity:null,pendingEvents:this._pendingEvents}}getStats(){return{sent:this._eventsSent,errors:this._errorCount,pending:this._pendingEvents}}init(t){(null==t?void 0:t.endpoint)?!1!==t.respectDoNotTrack&&this._isDoNotTrackEnabled()?this._logInfo("Do Not Track is enabled, tracking disabled"):(this._initialized&&this._removeEventListeners(),this._endpoint=t.endpoint.replace(/\/$/,""),this._lastActivity=Date.now(),this._autoTrack=t.autoTrack||!1,this._debug=t.debug||!1,t.sessionTimeout&&(this._sessionTimeout=t.sessionTimeout),this._initSession(t.sessionId),this._initialized=!0,this._restoreUserId(),this._boundHandlers.visibilityChange=()=>{"visible"===document.visibilityState&&this._checkSession()},this._boundHandlers.beforeUnload=()=>{this._lastActivity=Date.now()},document.addEventListener("visibilitychange",this._boundHandlers.visibilityChange),window.addEventListener("beforeunload",this._boundHandlers.beforeUnload),this._autoTrack&&this._setupAutoTracking(!1!==t.trackInitialPageView),this._logInfo("Client initialized",{endpoint:this._endpoint,autoTrack:this._autoTrack,sessionId:this._sessionId})):console.error("Ultralytics: endpoint is required")}_isDoNotTrackEnabled(){const t=navigator,s=window;return"1"===t.doNotTrack||"yes"===t.doNotTrack||"1"===t.msDoNotTrack||"1"===s.doNotTrack}_initSession(t){if(t)return this._sessionId=t,this._logDebug("Using provided session ID",{sessionId:this._sessionId}),void this._storeSession();const s=this._getStoredSession();s&&Date.now()-s.lastActivity<this._sessionTimeout?(this._sessionId=s.id,this._lastActivity=s.lastActivity,this._logDebug("Session restored",{sessionId:this._sessionId})):(this._sessionId=this._generateId(),this._logDebug("New session created",{sessionId:this._sessionId})),this._storeSession()}_checkSession(){if(!this._lastActivity||Date.now()-this._lastActivity>this._sessionTimeout){const t=this._sessionId;this._sessionId=this._generateId(),this._logDebug("Session expired, created new session",{oldSessionId:t,newSessionId:this._sessionId})}this._lastActivity=Date.now(),this._storeSession()}_setupAutoTracking(t){t&&(this._lastTrackedPath=window.location.pathname,this.trackPageView()),this._boundHandlers.popState=()=>this._onHistoryChange(),window.addEventListener("popstate",this._boundHandlers.popState);const s=this,e=t=>function(...e){t.apply(this,e),s._onHistoryChange()};history.pushState=e(history.pushState.bind(history)),history.replaceState=e(history.replaceState.bind(history))}_onHistoryChange(){const t=window.location.pathname;t!==this._lastTrackedPath&&(this._lastTrackedPath=t,this._logDebug("History change detected, tracking page view",{path:t}),this.trackPageView())}_generateId(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const s=16*Math.random()|0;return("x"===t?s:3&s|8).toString(16)})}_storeSession(){this._storage.set(t,JSON.stringify({id:this._sessionId,lastActivity:this._lastActivity}))}_getStoredSession(){const s=this._storage.get(t);return s?JSON.parse(s):null}_restoreUserId(){const t=this._storage.get(s);t&&(this._userId=t)}track(t,s){if(!this._initialized)return void console.error("Ultralytics: not initialized. Call init() first.");this._sessionId||(this._sessionId=this._generateId(),this._storeSession(),this._logDebug("Session created on track",{sessionId:this._sessionId})),this._lastActivity=Date.now(),this._storeSession();const e={name:t,properties:s||{},sessionId:this._sessionId,userId:this._userId,timestamp:(new Date).toISOString()};this._logDebug("Tracking event",{name:t,properties:s}),this._send("/api/events",e)}trackPageView(t){this.track("page_view",{url:window.location.href,path:window.location.pathname,title:document.title,referrer:document.referrer||null,...t})}_removeEventListeners(){const t=this._boundHandlers;t.visibilityChange&&document.removeEventListener("visibilitychange",t.visibilityChange),t.beforeUnload&&window.removeEventListener("beforeunload",t.beforeUnload),t.popState&&window.removeEventListener("popstate",t.popState),this._boundHandlers={}}destroy(){this._initialized&&(this._logInfo("Destroying client",this.getStats()),this._removeEventListeners(),this._initialized=!1,this._endpoint=null,this._sessionId=null,this._userId=null,this._autoTrack=!1,this._lastTrackedPath=null)}trackEvent(t,s){console.warn("Ultralytics: trackEvent() is deprecated. Use track() instead."),this.track(t,{eventType:"custom",...s})}reset(){this._logInfo("Resetting client state"),this._sessionId=this._generateId(),this._userId=null,this._storage.remove(s),this._storeSession(),this._eventsSent=0,this._errorCount=0}identify(t,e){this._initialized?t?(this._userId=t,this._storage.set(s,t),e&&this.track("identify",e),this._logInfo("User identified",{userId:t,hasTraits:!!e})):console.error("Ultralytics: userId is required for identify()"):console.error("Ultralytics: not initialized. Call init() first.")}getUserId(){return this._userId}clearUser(){this._userId=null,this._storage.remove(s)}trackBatch(t,s){if(!this._initialized){const t=new Error("Ultralytics: not initialized. Call init() first.");return console.error(t.message),void(null==s||s(t))}if(!Array.isArray(t)||!t.length){const t=new Error("Ultralytics: events must be a non-empty array");return console.error(t.message),void(null==s||s(t))}this._lastActivity=Date.now(),this._storeSession();const e=t.map(t=>({name:t.name,properties:t.properties||{},sessionId:this._sessionId,userId:this._userId,timestamp:t.timestamp||(new Date).toISOString()}));this._logDebug("Tracking batch",{eventCount:t.length}),this._sendBatch(e,s)}_sendBatch(t,s){this._pendingEvents+=t.length;const e=new XMLHttpRequest;e.open("POST",this._endpoint+"/api/events/batch",!0),e.setRequestHeader("Content-Type","application/json"),e.onreadystatechange=()=>{if(4===e.readyState)if(this._pendingEvents-=t.length,e.status>=200&&e.status<300){this._eventsSent+=t.length,this._logDebug("Batch sent successfully",{count:t.length,status:e.status});try{null==s||s(null,JSON.parse(e.responseText))}catch{null==s||s(null,{success:!0})}}else this._logError("Batch send failed",{status:e.status,response:e.responseText,eventCount:t.length}),null==s||s(new Error("Batch failed: "+e.status))},e.send(JSON.stringify({events:t}))}_send(t,s){this._pendingEvents++;const e=new XMLHttpRequest;e.open("POST",this._endpoint+t,!0),e.setRequestHeader("Content-Type","application/json"),e.onreadystatechange=()=>{4===e.readyState&&(this._pendingEvents--,e.status>=200&&e.status<300?(this._eventsSent++,this._logDebug("Event sent successfully",{name:s.name,status:e.status})):this._logError("Event send failed",{name:s.name,status:e.status,response:e.responseText}))},e.send(JSON.stringify(s))}}exports.UltralyticsClient=e;const i=new e;exports.Ultralytics=i,"undefined"!=typeof window&&(window.Ultralytics=i),exports.default=i});
//# sourceMappingURL=ultralytics.min.js.map
