{"version":3,"file":"ultralytics.min.js","sources":["../src/client.js"],"sourcesContent":["/**\n * Ultralytics Browser Client\n * A lightweight analytics tracking library\n */\n(function(window) {\n  'use strict';\n\n  var Ultralytics = {\n    _initialized: false,\n    _endpoint: null,\n    _sessionId: null,\n    _userId: null,\n    _sessionTimeout: 30 * 60 * 1000, // 30 minutes\n    _lastActivity: null,\n    _boundHandlers: {},\n\n    /**\n     * Initialize the Ultralytics client\n     * @param {Object} options - Configuration options\n     * @param {string} options.endpoint - The server endpoint URL\n     */\n    init: function(options) {\n      if (!options || !options.endpoint) {\n        console.error('Ultralytics: endpoint is required');\n        return;\n      }\n\n      // Clean up any existing listeners to prevent memory leaks\n      // This handles the case where init() is called multiple times\n      if (this._initialized) {\n        this._removeEventListeners();\n      }\n\n      this._endpoint = options.endpoint.replace(/\\/$/, '');\n      this._lastActivity = Date.now();\n\n      // Initialize session synchronously to avoid race conditions\n      // where track() might be called before sessionId is set\n      this._initSession();\n\n      // Only mark as initialized after session is ready\n      this._initialized = true;\n\n      // Restore user ID from localStorage if available\n      this._restoreUserId();\n\n      // Store bound event handlers for cleanup\n      this._boundHandlers.visibilityChange = function() {\n        if (document.visibilityState === 'visible') {\n          Ultralytics._checkSession();\n        }\n      };\n      this._boundHandlers.beforeUnload = function() {\n        Ultralytics._lastActivity = Date.now();\n      };\n\n      // Track page visibility changes\n      document.addEventListener('visibilitychange', this._boundHandlers.visibilityChange);\n\n      // Track before unload\n      window.addEventListener('beforeunload', this._boundHandlers.beforeUnload);\n\n      console.log('Ultralytics initialized');\n    },\n\n    /**\n     * Initialize or restore session\n     */\n    _initSession: function() {\n      var stored = this._getStoredSession();\n      \n      if (stored && (Date.now() - stored.lastActivity) < this._sessionTimeout) {\n        this._sessionId = stored.id;\n        this._lastActivity = stored.lastActivity;\n      } else {\n        // Generate new session ID\n        this._sessionId = this._generateId();\n      }\n      \n      this._storeSession();\n    },\n\n    /**\n     * Check if session is still valid\n     */\n    _checkSession: function() {\n      if (!this._lastActivity || (Date.now() - this._lastActivity) > this._sessionTimeout) {\n        this._sessionId = this._generateId();\n      }\n      this._lastActivity = Date.now();\n      this._storeSession();\n    },\n\n    /**\n     * Generate a unique ID\n     */\n    _generateId: function() {\n      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = Math.random() * 16 | 0;\n        var v = c === 'x' ? r : (r & 0x3 | 0x8);\n        return v.toString(16);\n      });\n    },\n\n    /**\n     * Store session in localStorage\n     */\n    _storeSession: function() {\n      try {\n        localStorage.setItem('ultralytics_session', JSON.stringify({\n          id: this._sessionId,\n          lastActivity: this._lastActivity\n        }));\n      } catch (e) {\n        // localStorage not available\n      }\n    },\n\n    /**\n     * Get stored session from localStorage\n     */\n    _getStoredSession: function() {\n      try {\n        var stored = localStorage.getItem('ultralytics_session');\n        return stored ? JSON.parse(stored) : null;\n      } catch (e) {\n        return null;\n      }\n    },\n\n    /**\n     * Restore user ID from localStorage\n     */\n    _restoreUserId: function() {\n      try {\n        var userId = localStorage.getItem('ultralytics_user_id');\n        if (userId) {\n          this._userId = userId;\n        }\n      } catch (e) {\n        // localStorage not available\n      }\n    },\n\n    /**\n     * Track an event\n     * @param {string} name - Event name\n     * @param {Object} properties - Event properties\n     */\n    track: function(name, properties) {\n      if (!this._initialized) {\n        console.error('Ultralytics: not initialized. Call init() first.');\n        return;\n      }\n\n      // Ensure we have a session ID (defensive check)\n      if (!this._sessionId) {\n        this._sessionId = this._generateId();\n        this._storeSession();\n      }\n\n      this._lastActivity = Date.now();\n      this._storeSession();\n\n      var data = {\n        name: name,\n        properties: properties || {},\n        sessionId: this._sessionId,\n        userId: this._userId,\n        timestamp: new Date().toISOString()\n      };\n\n      this._send('/api/events', data);\n    },\n\n    /**\n     * Track a page view\n     * @param {Object} properties - Additional page view properties\n     */\n    trackPageView: function(properties) {\n      var pageProps = {\n        url: window.location.href,\n        path: window.location.pathname,\n        title: document.title,\n        referrer: document.referrer || null\n      };\n\n      // Merge custom properties\n      if (properties) {\n        for (var key in properties) {\n          if (properties.hasOwnProperty(key)) {\n            pageProps[key] = properties[key];\n          }\n        }\n      }\n\n      this.track('page_view', pageProps);\n    },\n\n    /**\n     * Remove event listeners (internal helper)\n     */\n    _removeEventListeners: function() {\n      if (this._boundHandlers.visibilityChange) {\n        document.removeEventListener('visibilitychange', this._boundHandlers.visibilityChange);\n      }\n      if (this._boundHandlers.beforeUnload) {\n        window.removeEventListener('beforeunload', this._boundHandlers.beforeUnload);\n      }\n      this._boundHandlers = {};\n    },\n\n    /**\n     * Clean up event listeners and reset state\n     * Call this when removing the tracker\n     */\n    destroy: function() {\n      if (!this._initialized) {\n        return;\n      }\n\n      // Remove event listeners\n      this._removeEventListeners();\n\n      // Reset state\n      this._initialized = false;\n      this._endpoint = null;\n      this._sessionId = null;\n      this._userId = null;\n\n      console.log('Ultralytics destroyed');\n    },\n\n    /**\n     * Track a custom event (alias for track with event type)\n     * @param {string} eventName - Name of the event\n     * @param {Object} properties - Event properties\n     */\n    trackEvent: function(eventName, properties) {\n      var eventProps = {\n        eventType: 'custom'\n      };\n\n      // Merge custom properties\n      if (properties) {\n        for (var key in properties) {\n          if (properties.hasOwnProperty(key)) {\n            eventProps[key] = properties[key];\n          }\n        }\n      }\n\n      this.track(eventName, eventProps);\n    },\n\n    /**\n     * Identify a user\n     * @param {string} userId - Unique user identifier\n     * @param {Object} traits - Optional user traits/properties\n     */\n    identify: function(userId, traits) {\n      if (!this._initialized) {\n        console.error('Ultralytics: not initialized. Call init() first.');\n        return;\n      }\n\n      if (!userId) {\n        console.error('Ultralytics: userId is required for identify()');\n        return;\n      }\n\n      this._userId = userId;\n      \n      // Store user ID in localStorage for persistence\n      try {\n        localStorage.setItem('ultralytics_user_id', userId);\n      } catch (e) {\n        // localStorage not available\n      }\n\n      // Optionally track an identify event with user traits\n      if (traits) {\n        this.track('identify', traits);\n      }\n\n      console.log('Ultralytics: user identified', userId);\n    },\n\n    /**\n     * Get the current user ID\n     * @returns {string|null} The current user ID or null\n     */\n    getUserId: function() {\n      return this._userId;\n    },\n\n    /**\n     * Clear the current user (for logout scenarios)\n     */\n    clearUser: function() {\n      this._userId = null;\n      try {\n        localStorage.removeItem('ultralytics_user_id');\n      } catch (e) {\n        // localStorage not available\n      }\n    },\n\n    /**\n     * Track multiple events in a single request\n     * @param {Array} events - Array of event objects with name and optional properties\n     * @param {Function} callback - Optional callback(error, result)\n     */\n    trackBatch: function(events, callback) {\n      if (!this._initialized) {\n        var error = new Error('Ultralytics: not initialized. Call init() first.');\n        console.error(error.message);\n        if (callback) callback(error);\n        return;\n      }\n\n      if (!Array.isArray(events) || events.length === 0) {\n        var error = new Error('Ultralytics: events must be a non-empty array');\n        console.error(error.message);\n        if (callback) callback(error);\n        return;\n      }\n\n      this._lastActivity = Date.now();\n      this._storeSession();\n\n      // Prepare events with session and user info\n      var self = this;\n      var preparedEvents = events.map(function(event) {\n        return {\n          name: event.name,\n          properties: event.properties || {},\n          sessionId: self._sessionId,\n          userId: self._userId,\n          timestamp: event.timestamp || new Date().toISOString()\n        };\n      });\n\n      this._sendBatch(preparedEvents, callback);\n    },\n\n    /**\n     * Send batch data to the server\n     */\n    _sendBatch: function(events, callback) {\n      var xhr = new XMLHttpRequest();\n      xhr.open('POST', this._endpoint + '/api/events/batch', true);\n      xhr.setRequestHeader('Content-Type', 'application/json');\n      \n      xhr.onreadystatechange = function() {\n        if (xhr.readyState === 4) {\n          if (xhr.status >= 200 && xhr.status < 300) {\n            if (callback) {\n              try {\n                var result = JSON.parse(xhr.responseText);\n                callback(null, result);\n              } catch (e) {\n                callback(null, { success: true });\n              }\n            }\n          } else {\n            var error = new Error('Failed to send batch: ' + xhr.status);\n            console.error('Ultralytics: failed to send batch', xhr.status);\n            if (callback) callback(error);\n          }\n        }\n      };\n\n      xhr.send(JSON.stringify({ events: events }));\n    },\n\n    /**\n     * Send data to the server\n     */\n    _send: function(path, data) {\n      var xhr = new XMLHttpRequest();\n      xhr.open('POST', this._endpoint + path, true);\n      xhr.setRequestHeader('Content-Type', 'application/json');\n      \n      xhr.onreadystatechange = function() {\n        if (xhr.readyState === 4) {\n          if (xhr.status >= 200 && xhr.status < 300) {\n            // Success\n          } else {\n            console.error('Ultralytics: failed to send event', xhr.status);\n          }\n        }\n      };\n\n      xhr.send(JSON.stringify(data));\n    }\n  };\n\n  // Expose to window\n  window.Ultralytics = Ultralytics;\n\n})(window);\n"],"names":["window","Ultralytics","_initialized","_endpoint","_sessionId","_userId","_sessionTimeout","_lastActivity","_boundHandlers","init","options","endpoint","this","_removeEventListeners","replace","Date","now","_initSession","_restoreUserId","visibilityChange","document","visibilityState","_checkSession","beforeUnload","addEventListener","console","log","error","stored","_getStoredSession","lastActivity","id","_generateId","_storeSession","c","r","Math","random","toString","localStorage","setItem","JSON","stringify","e","getItem","parse","userId","track","name","properties","data","sessionId","timestamp","toISOString","_send","trackPageView","pageProps","url","location","href","path","pathname","title","referrer","key","hasOwnProperty","removeEventListener","destroy","trackEvent","eventName","eventProps","eventType","identify","traits","getUserId","clearUser","removeItem","trackBatch","events","callback","Error","message","Array","isArray","length","self","preparedEvents","map","event","_sendBatch","xhr","XMLHttpRequest","open","setRequestHeader","onreadystatechange","readyState","status","result","responseText","success","send"],"mappings":"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"}